\documentclass[11pt]{article}
\usepackage{amsmath, amsthm, amssymb, amsfonts}
\usepackage{dependencies/bussproofs}

\setlength{\topmargin}{-.65in}
\setlength{\oddsidemargin}{-0.1in}
\addtolength{\textwidth}{1.35in}
\addtolength{\textheight}{1.40in}
\setlength{\footskip}{0.3in}

\include{macros}

\title{Proof Rules for LF Reasoning}

\begin{document}

\maketitle

\section{Formulas and Sequents}

\begin{definition}[Substitution]
[still to do]
\end{definition}

\begin{definition}[Weak Typing]
We use a weaker notion of typing in this system where two types
$(a\app t_1\ldots t_n)$ and $(a\app s_1\ldots s_n)$ match regardless
of the $t_1,\ldots,t_n$ and $s_1,\ldots,s_n$.
%
This is extended to types $\typedpi{x}{A_1}{A_2}$ and
$\typedpi{x}{B_1}{B_2}$ by applying this notion of matching to
$A_1$ and $B_1$ as well as $A_2$ and $B_2$.

A context $\Gamma$ is weakly well formed if is a well formed context
in LF using this weaker notion of type matching.

A term $M$ is weakly well typed at $A$ under $\Gamma$ if
$\lfprove{\Gamma}{M:A}$ is derivable in LF using this weaker notion of
type matching.
\end{definition}

\begin{definition}[Block]
A {\it block} is a description of a sequence of type assignments which
might appear within a context.
%
A block consists of two parts; first is a sequence of type assignments
for the free variables which appear in the block and second is the
sequence of assignments which make up the block itself.
%
\[
Block ::= (x_1:A_1,\ldots,x_n:A_n)[y_1:B_1,\ldots,y_m:B_m]
\]

A block definition is {\it well formed} if each of
\[\lfprove{x_1:A_1,\ldots,x_{i-1}:A_{i-1}}{x_i:A_i}\] 
and
\[\lfprove{x_1:A_1,\ldots,x_n:A_n,y_1:B_1,\ldots,y_{j-1}:B_{j-1}}{y_j:B_j}\]
are derivable.
\end{definition}

\begin{definition}[Block Instances]
An {\it instance} of such a block definition is a sequence of type
assignments $(n_1:C_1,\ldots,n_m:C_m)$ where for some $t_1,\ldots,t_n$
each $C_i=\subst{t_1/x_1,\ldots,t_n/x_n}{B_i}$.

An instance $(n_1:C_1,\ldots,n_m:C_m)$ is 
{\it well formed under context $\Gamma$} if additionally each 
\[\lfprove{\Gamma}{t_i:\subst{t_1/x_1,\ldots,t_{i-1}/x_{i-1}}{A_i}}\]
is derivable.
%
It is {\it weakly well formed under context $\Gamma$} if each
\[\lfprove{\Gamma}{t_i:\subst{t_1/x_1,\ldots,t_{i-1}/x_{i-1}}{A_i}}\]
is derivable using the weakened notion of type matching.
\end{definition}

\begin{definition}[Context Schema]
A {\it context schema } describes a collection of LF contexts which
are constructed from a sequence of well formed block instances.
%
These contexts may be made up of blocks of more than one structure and
so context schemas are defined by giving a list of the block
definitions which may be used.
%
These schemas are given an identifier so that they can be refered to
by name.
%
\begin{align*}
Blocks \quad &::=\quad Block\ |\ Blocks,Block\\
Context\ Schema \quad &::=\quad ident = Blocks
\end{align*}

A context schema is well formed if each of the block definitions it
contains are well formed.
\end{definition}

\begin{definition}[Context Variable]
We use {\it context variables} $\Gamma$ to represent unknown or
partially specified contexts of a particular context schema structure.
%
Context variables are given types of the form 
$\ctxty{id}{\cal B}$ where $id$ is the identifier for a context
schema and $\cal B$ is a finite sequence of block instances
$b_1,\ldots,b_m$.
%
This sequence of block instances represents the partially specified
structure of a context and context variables typed in this way are
meant to be read schematically as
$\Gamma_1,b_1,\ldots,\Gamma_m,b_m,\Gamma_{m+1}$ where
$\Gamma_1,\ldots,\Gamma_{m+1}$ are all context variables satisfying
the same schema definition and which represent the parts of the
contexts still unspecified.

A type $\ctxty{id}{b_1,\ldots,b_m}$ is well formed under a context
$\Gamma$ if each $b_i$ is a well formed instance of one of the block
definitions contained in the definition of the schema $id$ under the
context $\Gamma,b_1,\ldots,b_{i-1}$.
%
It is {\it weakly well formed under $\Gamma$} if each $b_i$ is a
weakly well formed instance of one of the block definitions under
context $\Gamma,b_1,\ldots,b_{i-1}$.
\end{definition}

\begin{definition}[Context Variable Context]
A collection of type assignments for context variables,
$\mathcal{C}=\Gamma_1:\ctxty{c_1}{\cal{B_1}},\ldots,\Gamma_n:\ctxty{c_n}{\cal{B_n}}$,
is a context variable context.

Such a context is well formed under a context $\Psi$ if each
$\Gamma_i$ appears only once in the context and each type
$\ctxty{c_i}{\cal{B_i}}$ is a well formed type under $\Psi$.
%
Note that we will now use $\Psi$ to refer to regular contexts to
reduce confusion between context variables and actual contexts.
%
We similarly define a notion of {\it weakly well typed} context
variable contexts using the weak notion of well formedness for context
variable types.
\end{definition}

\begin{definition}[Context Expressions]
A {\it context expression } $G$ has two parts, one that is not fully
specified and one which is concrete.
%
The first is represented by a context variable if non-empty, and the
second is given as a list of specific type assignments.
%
\[
G ::=  \Gamma\ |\ \cdot\ |\ G,n:A
\]

A context expression $G$ is 
{\it well formed under context variable context $\mathcal{C}$ and
  context $\Psi$} if 
$\wfctx{\Psi}{\mathcal{C}}{G}$ is derivable following the rules
given below and $\mathcal{C}$ is a weakly well formed context variable
context under $\Psi$.
%
\begin{center}
\AxiomC{}
\UnaryInfC{$\wfctx{\Psi}{\mathcal{C}}{\cdot}$}
\DisplayProof
%
\quad \quad
%
\AxiomC{$\Gamma:\ctxty{id}{\cal B}\in\mathcal{C}$}
\UnaryInfC{$\wfctx{\Psi}{\mathcal{C}}{\Gamma}$}
\DisplayProof

\medskip

\AxiomC{$n$ does not appear in $G$}
\AxiomC{$\wfctx{\Psi}{\mathcal{C}}{G}$}
\BinaryInfC{$\wfctx{\Psi}{\mathcal{C}}{G,n:A}$}
\DisplayProof
\end{center}

\end{definition}

\begin{definition}[Formulas]
The {\it formulas} of the system are given by the following syntax.
%
\[
F ::= \fatm{G}{M : A}\ |\ \fall{X}{F}\ |\ \fexists{X}{F}\ |\ \fctx{\Gamma}{id}{F}
      \ |\ \fand{F_1}{F_2}\ |\ \for{F_1}{F_2}\ |\ \fimp{F_1}{F_2}\ |\
      \top\ |\ \bot \ |\ \feq{t_1}{t_2}
\]

The validity of formulas is interpreted as given in the following
table.

\begin{tabular}{l p{10cm}}
$\fatm{G}{M:A}$ & is valid if $\lfprove{G}{M:A}$ is derivable in LF\\
$\fctx{\Gamma}{id}{F}$ & 
  is valid if for every valid LF context $G$ satisfying the context
  schema $id$, $\subst{G/\Gamma}{F}$ is valid\\
$\fall{X}{F}$ & 
  is valid if for every closed expression $t$, $\subst{t/X}{F}$ is
  valid\\
$\fexists{X}{F}$ &
  is valid if there is a closed expression $t$ such that
  $\subst{t/X}{F}$ is valid\\
$\fimp{F_1}{F_2}$ & 
  is valid if whenever $F_1$ is valid $F_2$ must
  also be valid\\
$\fand{F_1}{F_2}$ & is valid if $F_1$ is valid and $F_2$ is valid\\
$\for{F_1}{F_2}$ & is valid if $F_1$ is valid or $F_2$ is valid\\
$\top$ & is true\\
$\bot$ & is false\\
$\feq{t_1}{t_2}$ & is valid if the terms $t_1$ and $t_2$ are equal
\end{tabular}

The formula $F$ is 
{\it well formed under context variable context $\mathcal{C}$ and
  context $\Psi$} if $\mathcal{C}$ is a well formed context variable
context under $\Psi$ and $\wfform{\Psi}{\mathcal{C}}{F}$ is
derivable following the rules given below.
%
\begin{center}
\AxiomC{$\lfprove{G}{M:A}$ using weak type matching}
\AxiomC{$\wfctx{\Psi}{\mathcal{C}}{G}$}
\BinaryInfC{$\wfform{\Psi}{\mathcal{C}}{\fatm{G}{M:A}}$}
\DisplayProof

\medskip

\AxiomC{$\wfform{\Psi,y:A}{\mathcal{C}}{F[y/X]}$}
\AxiomC{$y\not\in\Psi$}
\AxiomC{$Q\in\{\forall,\exists\}$}
\TrinaryInfC{$\wfform{\Psi}{\mathcal{C}}{Q~X.F}$}
\DisplayProof

\medskip

\AxiomC{$\wfform{\Psi}{\mathcal{C},\Gamma:\ctxty{ctx}{\cdot}}{F}$}
\AxiomC{$\Gamma\not\in\mathcal{C}$}
\BinaryInfC{$\wfform{\Psi}{\mathcal{C}}{\fctx{\Gamma}{ctx}{F}}$}
\DisplayProof

\medskip

\AxiomC{$\wfform{\Psi}{\mathcal{C}}{F_1}$}
\AxiomC{$\wfform{\Psi}{\mathcal{C}}{F_2}$}
\AxiomC{$C\in\{\wedge,\vee,\supset\}$}
\TrinaryInfC{$\wfform{\Psi}{\mathcal{C}}{F_1~C~F_2}$}
\DisplayProof

\medskip

\AxiomC{$V\in\{\top,\bot\}$}
\UnaryInfC{$\wfform{\Psi}{\mathcal{C}}{V}$}
\DisplayProof

\medskip

\AxiomC{$t_1$ and $t_2$ are $\Psi$-terms}
\UnaryInfC{$\wfform{\Psi}{\mathcal{C}}{\feq{t_1}{t_2}}$}
\DisplayProof
\end{center}
\end{definition}

\begin{definition}[Sequents]
A {\it sequent} $\seq{\Psi}{\mathcal{C}}{\Delta}{F}$ in this system
consists of a context $\Psi$, a context variable context
$\mathcal{C}$, a collection of assumptions $\Delta$, and a formula
$F$.
%
The context $\Psi$ gives types to all the free variables appearing in
the other components and $\mathcal{C}$ gives types to any context
variables appearing in $\Delta$ or $F$.

A sequent $\seq{\Psi}{\mathcal{C}}{\Delta}{F}$ is {\it well formed} if
each formula in $\Delta$ and $F$ are all well formed formulas under
$\mathcal{C}$ and $\Psi$.
\end{definition}

\begin{definition}[Validity of Sequent]
When $\Delta$ and $F$ contain no free variables or free context
variables then $\seqsans{\Delta}{F}$ is valid if whenever every
formula in the assumption set $\Delta$ is valid it means that $F$ must
also be valid.

Given an arbitrary sequent $\seq{\Psi}{\mathcal{C}}{\Delta}{F}$, the
sequent is valid if for each closed instance of each variable in
$\Psi$ and each closed instance of each context form in $\mathcal{C}$
the resulting assumption set $\Delta'$ and formula $F'$ are such that
$\seqsans{\Delta'}{F'}$ is valid.
\end{definition}


\section{Proof Rules}

\subsection{Induction}

Induction will only be applicable to the LF typing judgments
$\fatm{G}{M:A}$.
%
Such an assumption is implicitly considering derivations in LF of any
height and by explicitly considering the height of these derivations
we may perform natural number indution on the height.
%
Specifically, using induction will result in needing to show a
property holds for a derivation of height $n$ assuming that the
property holds for any derivation of height smaller than $n$.
%
From this we can conclude that the property holds for derivations of
any height.

The actual rule for induction we propose is slightly more restrictive
as it uses an annotation based approach to ensure the height is
smaller meaning we can only apply the induction hypothesis to smaller
derivations which arise from decomposing (using case analysis) the
derivation of height $n$.
%
This will mean that the system is not complete, though we will still
be able to show soundness of using induction.

\begin{definition}[Derivation Heights]
For the discussion of induction we introduce some new syntax in order
to describe LF derivations of particular heights.
%
We use natural numbers $n\in nat$ to denote heights, and use this
height to annotate atomic formulae; we require $n\in nat$ to appear in
the context $\Psi$ of a sequent containing free $n$ in the assumption
set or goal formula.
%
An atomic formula $\fatm{G}{M:A}^n$ expresses that the LF derivation
of $\lfprove{G}{M:A}$ has height $n$.
%
The syntax $\fatm{G}{M:A}$ stands for 
$\fexists{n\in nat}{\fatm{G}{M:A}^n}$ indicating that there exists
some derivation of $\lfprove{G}{M:A}$ in LF of some height.
\end{definition}

\begin{definition}[Annotations]
We introduce a scheme of annotating atomic formulae of the form
$\fatm{G}{M:A}$.
%
These annotations are used to indicate relative heights of
derivations.
%
Each formula of this form is given one of three annotations: (1) * (2)
@ or (3) no annotation.

An annotation of $@$ indicates a formula representing a derivation of
a particular height in LF.
%
An annotation of $*$ indicates a derivation which must be of smaller
height than the height associated with the $@$ annotation; this
annotation is used to indicate that an inductive hypothesis may only
be applied to a derivation obtained by performing case analysis (see
the definition of the induction rule below).
%
No annotation means that the derivation is of any height.
\end{definition}

\begin{definition}[induction]
The induction rule is defined as follows.

\begin{center}
\AxiomC{$\seq{\Psi}
             {\mathcal{C}}
             {\setand{\Delta}{\fimp{\ldots}{\fimp{\fatm{G}{M:A}^*}{\ldots}}}}
             {\fimp{\ldots}{\fimp{\fatm{G}{M:A}^@}{\ldots}}}$}
\UnaryInfC{$\seq{\Psi}{\mathcal{C}}{\Delta}{\fimp{\ldots}{\fimp{\fatm{G}{M:A}}{\ldots}}}$}
\DisplayProof
\end{center}

Note that case analysis on a formula annotated with wither $@$ or $*$
will result in annotations of $*$ and case analysis on formulas with
no annotation will result in no annotation.
\end{definition}

\begin{theorem}[Using Induction is Sound]
Whenever the sequent
%
\begin{gather*}
\seq{\Psi}
    {\mathcal{C}}
    {\setand{\Delta}
            {\fctx{\bar{\Gamma}}
                  {\bar{c}}
                  {\fall{\bar{x}}
                        {\fimp{F_1}
                              {\fimp{\ldots}
                                    {\fimp{\fatm{G}{M:A}^*}
                                          {\fimp{\ldots}
                                                {F_n}}}}}}}}
    {}\\
    {\fctx{\bar{\Gamma}}
          {\bar{c}}
          {\fall{\bar{x}}
                {\fimp{F_1}
                      {\fimp{\ldots}
                            {\fimp{\fatm{G}{M:A}^@}
                                  {\fimp{\ldots}
                                        {F_n}}}}}}}
\end{gather*}
%
is valid, the sequent
%
\[
\seq{\Psi}
    {\mathcal{C}}
    {\Delta}
    {\fctx{\bar{\Gamma}}
          {\bar{c}}
          {\fall{\bar{x}}
                {\fimp{F_1}
                      {\fimp{\ldots}
                            {\fimp{\fatm{G}{M:A}}
                                  {\fimp{\ldots}
                                        {F_n}}}}}}}
\]
% 
is also valid.
\end{theorem}
\begin{proof}
The later sequent uses $\fatm{G}{M:A}$ which is
shorthand for $(\fexists{n\in nat}{\fatm{G}{M:A}^n)}$.
%
So the formula 
%
\[
\fctx{\bar{\Gamma}}
     {\bar{c}}
     {\fall{\bar{x}}
           {\fimp{F_1}
                 {\fimp{\ldots}
                       {\fimp{\fatm{G}{M:A}}
                             {\fimp{\ldots}
                                   {F_n}}}}}}
\]
% 
is logically equivallent to 
%
\[
\fall{n\in nat}
     {(\fctx{\bar{\Gamma}}
            {\bar{c}}
            {\fall{\bar{x}}
                  {\fimp{F_1}
                        {\fimp{\ldots}
                              {\fimp{\fatm{G}{M:A}^n}
                                    {\fimp{\ldots}
                                          {F_n}}}}}})}.
\] 
%
Letting 
$P(n)=\fctx{\bar{\Gamma}}
           {\bar{c}}
           {\fall{\bar{x}}
                 {\fimp{F_1}
                       {\fimp{\ldots}
                             {\fimp{\fatm{G}{M:A}^n}
                                   {\fimp{\ldots}
                                         {F_n}}}}}}$ 
this amounts to showing $\fall{n\in nat}{P(n)}$.
%
Thus the sequent
%
\[
\seq{\Psi}
    {\mathcal{C}}
    {\Delta}
    {\fctx{\bar{\Gamma}}
          {\bar{c}}
          {\fall{\bar{x}}
                {\fimp{F_1}
                      {\fimp{\ldots}
                            {\fimp{\fatm{G}{M:A}}
                                  {\fimp{\ldots}
                                        {F_n}}}}}}}
\]
%
will be valid if the sequent
\[\seq{\Psi}{\mathcal{C}}{\Delta}{\fall{n\in nat}{P(n)}}\]
is valid.

Using the principle of strong induction for natural numbers,
$\fall{n\in nat}{P(n)}$ is valid if 
$\fall{n\in nat}{\fimp{(\fall{m\in nat}{\fimp{(m<n)}{P(m)}})}{P(n)}}$ 
is valid.
%
Thus the sequent 
\[\seq{\Psi}{\mathcal{C}}{\Delta}{\fall{n\in nat}{P(n)}}\]
will be valid if
%
\[
\seq{\Psi}
    {\mathcal{C}}
    {\Delta}
    {\fall{n\in nat}{\fimp{(\fall{m\in nat}{\fimp{(m<n)}{P(m)}})}{P(n)}}}
\]
%
is valid.
%
Given the soundness of the other rules, this will be valid if the
sequent
%
\[
\seq{\Psi,n\in nat}
    {\mathcal{C}}
    {\setand{\Delta}{\fall{m\in nat}{\fimp{(m<n)}{P(m)}}}}{P(n)}
\]
%
is valid.

[NOTE: This next part of the argument still feels like it is not quite
solid...]

Suppose that 
%
\begin{gather*}
\seq{\Psi}
    {\mathcal{C}}
    {\setand{\Delta}
            {\fctx{\bar{\Gamma}}
                  {\bar{c}}
                  {\fall{\bar{x}}
                        {\fimp{F_1}
                              {\fimp{\ldots}
                                    {\fimp{\fatm{G}{M:A}^*}
                                          {\fimp{\ldots}
                                                {F_n}}}}}}}}
    {}\\
    {\fctx{\bar{\Gamma}}
          {\bar{c}}
          {\fall{\bar{x}}
                {\fimp{F_1}
                      {\fimp{\ldots}
                            {\fimp{\fatm{G}{M:A}^@}
                                  {\fimp{\ldots}
                                        {F_n}}}}}}}
\end{gather*}
%
is valid.
%
Clearly if we are able to show this is valid using the annotation
scheme we should be able to show the previous sequent is valid since
the annotations will ensure that the inductive hypothesis may only be
applied to derivations with smaller height.
%
Therefore if the assumption sequent is valid then
%
\[
\seq{\Psi,n\in nat}
    {\mathcal{C}}
    {\setand{\Delta}{\fall{m\in nat}{\fimp{(m<n)}{P(m)}}}}{P(n)}
\]
%
must be valid and so
%
\[
\seq{\Psi}
    {\mathcal{C}}
    {\Delta}
    {\fctx{\bar{\Gamma}}
          {\bar{c}}
          {\fall{\bar{x}}
                {\fimp{F_1}
                      {\fimp{\ldots}
                            {\fimp{\fatm{G}{M:A}}
                                  {\fimp{\ldots}
                                        {F_n}}}}}}}
\]
%
is valid as needed.
\end{proof}

\end{document}
